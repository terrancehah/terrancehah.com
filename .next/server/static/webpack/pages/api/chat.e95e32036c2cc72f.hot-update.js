"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("pages/api/chat",{

/***/ "(middleware)/./utils/local-metrics.ts":
/*!********************************!*\
  !*** ./utils/local-metrics.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   METRICS_STORAGE_KEY: () => (/* binding */ METRICS_STORAGE_KEY),\n/* harmony export */   checkInputLimits: () => (/* binding */ checkInputLimits),\n/* harmony export */   checkSession: () => (/* binding */ checkSession),\n/* harmony export */   getStoredMetrics: () => (/* binding */ getStoredMetrics),\n/* harmony export */   resetMetrics: () => (/* binding */ resetMetrics),\n/* harmony export */   updateStoredMetrics: () => (/* binding */ updateStoredMetrics)\n/* harmony export */ });\n/* harmony import */ var _managers_stage_manager__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../managers/stage-manager */ \"(middleware)/./managers/stage-manager.ts\");\n/* harmony import */ var _session_manager__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./session-manager */ \"(middleware)/./utils/session-manager.ts\");\n\n\nconst METRICS_STORAGE_KEY = \"travel_interaction_metrics\";\nconst SESSION_KEY = \"travel_session_id\";\nconst MAX_TOTAL_INPUTS = 15;\nfunction getStoredMetrics() {\n    try {\n        // Check session validity first\n        if (!(0,_session_manager__WEBPACK_IMPORTED_MODULE_1__.checkSessionValidity)()) {\n            return resetMetrics();\n        }\n        const storedMetrics = localStorage.getItem(METRICS_STORAGE_KEY);\n        if (!storedMetrics) {\n            return resetMetrics();\n        }\n        const metrics = JSON.parse(storedMetrics);\n        // Ensure all fields exist\n        metrics.totalPrompts = metrics.totalPrompts || 0;\n        metrics.savedPlacesCount = metrics.savedPlacesCount || 0;\n        metrics.isPaid = metrics.isPaid || false;\n        metrics.stagePrompts = metrics.stagePrompts || {\n            1: 0,\n            2: 0,\n            3: 0\n        };\n        return metrics;\n    } catch (error) {\n        console.error(\"[Metrics] Error retrieving metrics:\", error);\n        return resetMetrics();\n    }\n}\nfunction updateStoredMetrics(currentStage, incrementPrompt = true) {\n    try {\n        const metrics = getStoredMetrics();\n        if (incrementPrompt) {\n            // Only increment if explicitly requested and not already at limit\n            const { withinStageLimit } = checkInputLimits(currentStage);\n            if (withinStageLimit) {\n                metrics.totalPrompts += 1;\n                if (!metrics.stagePrompts) {\n                    metrics.stagePrompts = {};\n                }\n                metrics.stagePrompts[currentStage] = (metrics.stagePrompts[currentStage] || 0) + 1;\n            }\n        }\n        // Save to storage\n        localStorage.setItem(METRICS_STORAGE_KEY, JSON.stringify(metrics));\n        return metrics;\n    } catch (error) {\n        console.error(\"[Metrics] Error updating metrics:\", error);\n        return getStoredMetrics();\n    }\n}\nfunction checkInputLimits(currentStage) {\n    const metrics = getStoredMetrics();\n    const stagePrompts = metrics.stagePrompts?.[currentStage] || 0;\n    const totalPrompts = metrics.totalPrompts || 0;\n    // Only apply stage limits to stage 3, all other stages should be unlimited\n    const result = {\n        withinStageLimit: currentStage === 3 ? stagePrompts < _managers_stage_manager__WEBPACK_IMPORTED_MODULE_0__.STAGE_LIMITS[3].maxPrompts : true,\n        withinTotalLimit: currentStage === 3 ? totalPrompts < MAX_TOTAL_INPUTS : true,\n        stageInputCount: stagePrompts,\n        totalInputCount: totalPrompts\n    };\n    // console.log(`[Metrics] Input limit check for stage ${currentStage}:`, result);\n    return result;\n}\nfunction resetMetrics() {\n    const metrics = {\n        totalPrompts: 0,\n        savedPlacesCount: 0,\n        isPaid: false,\n        stagePrompts: {\n            1: 0,\n            2: 0,\n            3: 0\n        }\n    };\n    localStorage.setItem(METRICS_STORAGE_KEY, JSON.stringify(metrics));\n    (0,_session_manager__WEBPACK_IMPORTED_MODULE_1__.initializeSession)(); // Initialize a new session when metrics are reset\n    return metrics;\n}\nfunction checkSession() {\n    const currentSession = localStorage.getItem(SESSION_KEY);\n    if (!currentSession) {\n        const newSession = Date.now().toString();\n        localStorage.setItem(SESSION_KEY, newSession);\n        resetMetrics();\n        return false;\n    }\n    return true;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QWFnQixPQUFPLENBQUNyQixhQUFhOEI7UUFDbEMzQjtRQUNBLE9BQU87SUFDVDtJQUNBLE9BQU87QUFDVCIsInNvdXJjZXMiOlsid2VicGFjazovL19OX0UvLi91dGlscy9sb2NhbC1tZXRyaWNzLnRzP2Y0NDEiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXNlckludGVyYWN0aW9uTWV0cmljcywgU1RBR0VfTElNSVRTIH0gZnJvbSAnLi4vbWFuYWdlcnMvc3RhZ2UtbWFuYWdlcic7XG5pbXBvcnQgeyBjaGVja1Nlc3Npb25WYWxpZGl0eSwgaW5pdGlhbGl6ZVNlc3Npb24sIGNsZWFyU2Vzc2lvbiB9IGZyb20gJy4vc2Vzc2lvbi1tYW5hZ2VyJztcblxuZXhwb3J0IGNvbnN0IE1FVFJJQ1NfU1RPUkFHRV9LRVkgPSAndHJhdmVsX2ludGVyYWN0aW9uX21ldHJpY3MnO1xuY29uc3QgU0VTU0lPTl9LRVkgPSAndHJhdmVsX3Nlc3Npb25faWQnO1xuY29uc3QgTUFYX1RPVEFMX0lOUFVUUyA9IDE1O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RvcmVkTWV0cmljcygpOiBVc2VySW50ZXJhY3Rpb25NZXRyaWNzIHtcbiAgdHJ5IHtcbiAgICAvLyBDaGVjayBzZXNzaW9uIHZhbGlkaXR5IGZpcnN0XG4gICAgaWYgKCFjaGVja1Nlc3Npb25WYWxpZGl0eSgpKSB7XG4gICAgICByZXR1cm4gcmVzZXRNZXRyaWNzKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RvcmVkTWV0cmljcyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKE1FVFJJQ1NfU1RPUkFHRV9LRVkpO1xuICAgIGlmICghc3RvcmVkTWV0cmljcykge1xuICAgICAgcmV0dXJuIHJlc2V0TWV0cmljcygpO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldHJpY3MgPSBKU09OLnBhcnNlKHN0b3JlZE1ldHJpY3MpO1xuICAgIFxuICAgIC8vIEVuc3VyZSBhbGwgZmllbGRzIGV4aXN0XG4gICAgbWV0cmljcy50b3RhbFByb21wdHMgPSBtZXRyaWNzLnRvdGFsUHJvbXB0cyB8fCAwO1xuICAgIG1ldHJpY3Muc2F2ZWRQbGFjZXNDb3VudCA9IG1ldHJpY3Muc2F2ZWRQbGFjZXNDb3VudCB8fCAwO1xuICAgIG1ldHJpY3MuaXNQYWlkID0gbWV0cmljcy5pc1BhaWQgfHwgZmFsc2U7XG4gICAgbWV0cmljcy5zdGFnZVByb21wdHMgPSBtZXRyaWNzLnN0YWdlUHJvbXB0cyB8fCB7IDE6IDAsIDI6IDAsIDM6IDAgfTtcblxuICAgIHJldHVybiBtZXRyaWNzO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1tNZXRyaWNzXSBFcnJvciByZXRyaWV2aW5nIG1ldHJpY3M6JywgZXJyb3IpO1xuICAgIHJldHVybiByZXNldE1ldHJpY3MoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlU3RvcmVkTWV0cmljcyhcbiAgY3VycmVudFN0YWdlOiBudW1iZXIsIFxuICBpbmNyZW1lbnRQcm9tcHQ6IGJvb2xlYW4gPSB0cnVlXG4pOiBVc2VySW50ZXJhY3Rpb25NZXRyaWNzIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBtZXRyaWNzID0gZ2V0U3RvcmVkTWV0cmljcygpO1xuICAgIFxuICAgIGlmIChpbmNyZW1lbnRQcm9tcHQpIHtcbiAgICAgIC8vIE9ubHkgaW5jcmVtZW50IGlmIGV4cGxpY2l0bHkgcmVxdWVzdGVkIGFuZCBub3QgYWxyZWFkeSBhdCBsaW1pdFxuICAgICAgY29uc3QgeyB3aXRoaW5TdGFnZUxpbWl0IH0gPSBjaGVja0lucHV0TGltaXRzKGN1cnJlbnRTdGFnZSk7XG4gICAgICBpZiAod2l0aGluU3RhZ2VMaW1pdCkge1xuICAgICAgICBtZXRyaWNzLnRvdGFsUHJvbXB0cyArPSAxO1xuICAgICAgICBpZiAoIW1ldHJpY3Muc3RhZ2VQcm9tcHRzKSB7XG4gICAgICAgICAgbWV0cmljcy5zdGFnZVByb21wdHMgPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBtZXRyaWNzLnN0YWdlUHJvbXB0c1tjdXJyZW50U3RhZ2VdID0gKG1ldHJpY3Muc3RhZ2VQcm9tcHRzW2N1cnJlbnRTdGFnZV0gfHwgMCkgKyAxO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBTYXZlIHRvIHN0b3JhZ2VcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShNRVRSSUNTX1NUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeShtZXRyaWNzKSk7XG4gICAgXG4gICAgcmV0dXJuIG1ldHJpY3M7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignW01ldHJpY3NdIEVycm9yIHVwZGF0aW5nIG1ldHJpY3M6JywgZXJyb3IpO1xuICAgIHJldHVybiBnZXRTdG9yZWRNZXRyaWNzKCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrSW5wdXRMaW1pdHMoXG4gIGN1cnJlbnRTdGFnZTogbnVtYmVyXG4pOiB7IFxuICB3aXRoaW5TdGFnZUxpbWl0OiBib29sZWFuLCBcbiAgd2l0aGluVG90YWxMaW1pdDogYm9vbGVhbixcbiAgc3RhZ2VJbnB1dENvdW50OiBudW1iZXIsXG4gIHRvdGFsSW5wdXRDb3VudDogbnVtYmVyXG59IHtcbiAgY29uc3QgbWV0cmljcyA9IGdldFN0b3JlZE1ldHJpY3MoKTtcbiAgXG4gIGNvbnN0IHN0YWdlUHJvbXB0cyA9IG1ldHJpY3Muc3RhZ2VQcm9tcHRzPy5bY3VycmVudFN0YWdlXSB8fCAwO1xuICBjb25zdCB0b3RhbFByb21wdHMgPSBtZXRyaWNzLnRvdGFsUHJvbXB0cyB8fCAwO1xuXG4gICAvLyBPbmx5IGFwcGx5IHN0YWdlIGxpbWl0cyB0byBzdGFnZSAzLCBhbGwgb3RoZXIgc3RhZ2VzIHNob3VsZCBiZSB1bmxpbWl0ZWRcbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIHdpdGhpblN0YWdlTGltaXQ6IGN1cnJlbnRTdGFnZSA9PT0gMyA/IFxuICAgICAgc3RhZ2VQcm9tcHRzIDwgU1RBR0VfTElNSVRTWzNdLm1heFByb21wdHMgOiBcbiAgICAgIHRydWUsICAvLyBBbHdheXMgdHJ1ZSBmb3Igbm9uLXN0YWdlIDNcbiAgICB3aXRoaW5Ub3RhbExpbWl0OiBjdXJyZW50U3RhZ2UgPT09IDMgPyBcbiAgICAgIHRvdGFsUHJvbXB0cyA8IE1BWF9UT1RBTF9JTlBVVFMgOlxuICAgICAgdHJ1ZSwgIC8vIEFsd2F5cyB0cnVlIGZvciBub24tc3RhZ2UgM1xuICAgIHN0YWdlSW5wdXRDb3VudDogc3RhZ2VQcm9tcHRzLFxuICAgIHRvdGFsSW5wdXRDb3VudDogdG90YWxQcm9tcHRzXG4gIH07XG5cbiAgLy8gY29uc29sZS5sb2coYFtNZXRyaWNzXSBJbnB1dCBsaW1pdCBjaGVjayBmb3Igc3RhZ2UgJHtjdXJyZW50U3RhZ2V9OmAsIHJlc3VsdCk7XG4gIFxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRNZXRyaWNzKCkge1xuICBjb25zdCBtZXRyaWNzID0ge1xuICAgIHRvdGFsUHJvbXB0czogMCxcbiAgICBzYXZlZFBsYWNlc0NvdW50OiAwLFxuICAgIGlzUGFpZDogZmFsc2UsXG4gICAgc3RhZ2VQcm9tcHRzOiB7IDE6IDAsIDI6IDAsIDM6IDAgfVxuICB9O1xuICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShNRVRSSUNTX1NUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeShtZXRyaWNzKSk7XG4gIGluaXRpYWxpemVTZXNzaW9uKCk7IC8vIEluaXRpYWxpemUgYSBuZXcgc2Vzc2lvbiB3aGVuIG1ldHJpY3MgYXJlIHJlc2V0XG4gIHJldHVybiBtZXRyaWNzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tTZXNzaW9uKCk6IGJvb2xlYW4ge1xuICBjb25zdCBjdXJyZW50U2Vzc2lvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNFU1NJT05fS0VZKTtcbiAgXG4gIGlmICghY3VycmVudFNlc3Npb24pIHtcbiAgICBjb25zdCBuZXdTZXNzaW9uID0gRGF0ZS5ub3coKS50b1N0cmluZygpO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNFU1NJT05fS0VZLCBuZXdTZXNzaW9uKTtcbiAgICByZXNldE1ldHJpY3MoKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59XG4iXSwibmFtZXMiOlsiU1RBR0VfTElNSVRTIiwiY2hlY2tTZXNzaW9uVmFsaWRpdHkiLCJpbml0aWFsaXplU2Vzc2lvbiIsIk1FVFJJQ1NfU1RPUkFHRV9LRVkiLCJTRVNTSU9OX0tFWSIsIk1BWF9UT1RBTF9JTlBVVFMiLCJnZXRTdG9yZWRNZXRyaWNzIiwicmVzZXRNZXRyaWNzIiwic3RvcmVkTWV0cmljcyIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJtZXRyaWNzIiwiSlNPTiIsInBhcnNlIiwidG90YWxQcm9tcHRzIiwic2F2ZWRQbGFjZXNDb3VudCIsImlzUGFpZCIsInN0YWdlUHJvbXB0cyIsImVycm9yIiwiY29uc29sZSIsInVwZGF0ZVN0b3JlZE1ldHJpY3MiLCJjdXJyZW50U3RhZ2UiLCJpbmNyZW1lbnRQcm9tcHQiLCJ3aXRoaW5TdGFnZUxpbWl0IiwiY2hlY2tJbnB1dExpbWl0cyIsInNldEl0ZW0iLCJzdHJpbmdpZnkiLCJyZXN1bHQiLCJtYXhQcm9tcHRzIiwid2l0aGluVG90YWxMaW1pdCIsInN0YWdlSW5wdXRDb3VudCIsInRvdGFsSW5wdXRDb3VudCIsImNoZWNrU2Vzc2lvbiIsImN1cnJlbnRTZXNzaW9uIiwibmV3U2Vzc2lvbiIsIkRhdGUiLCJub3ciLCJ0b1N0cmluZyJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(middleware)/./utils/local-metrics.ts\n");

/***/ })

});